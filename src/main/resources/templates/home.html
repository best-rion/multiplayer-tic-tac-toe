<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <title>tic-tac-toe</title>
</head>
<body>
    <form>
        <div>
            <label for="connect">WebSocket connection:</label>
            <button id="connect" type="submit">Connect</button>
            <button id="disconnect" type="submit" disabled="disabled">Disconnect</button>
        </div>
    </form>
    
    <div id="container"></div>
	<input type="text" th:value="${principal.username}" id="username">

	<input type="text" th:value="${principal.opponent}" id="opponent">

<script>

    var cells = new Array()

    var container = document.getElementById("container")

    window.onload = ()=>{

        for (var y=0; y<3; y++)
        {
			var row = new Array()
            for (var x=0; x<3; x++)
            {
                var cell = document.createElement("button")
                cell.setAttribute("class", "cell")
                cell.setAttribute("onclick", "makeMove("+x+","+y+")")
                cell.style.left = (50*x)+"px"
                cell.style.top = (50*y)+"px"
                container.appendChild(cell)
				row.push(cell)
            }
			cells.push(row)
        }
    }

	function makeMove(x,y)
	{
        stompClient.publish({
            destination: "/app/move",
            body: JSON.stringify({'x': x, 'y': y, 'opponent':$("#opponent").val()})
        });
	}

    function updateBoard(move)
    {
        var x = parseInt(move.x)
        var y = parseInt(move.y)
        
        cells[y][x].innerHTML = 'O'

    }


    const stompClient = new StompJs.Client({
        brokerURL: 'ws://localhost:8080/gs-guide-websocket'
    });

    stompClient.onConnect = (frame) => {
        setConnected(true);
        console.log('Connected: ' + frame);
        stompClient.subscribe('/user/queue/private', (move) => {
            console.log(move.headers["message-id"])
            updateBoard(JSON.parse(move.body));
        });
		
		stompClient.publish({
            destination: "/app/map",
            body: JSON.stringify({'username':$("#username").val()})
        });
    };

    stompClient.onWebSocketError = (error) => {
        console.error('Error with websocket', error);
    };

    stompClient.onStompError = (frame) => {
        console.error('Broker reported error: ' + frame.headers['message']);
        console.error('Additional details: ' + frame.body);
    };

    function setConnected(connected) {
        $("#connect").prop("disabled", connected);
        $("#disconnect").prop("disabled", !connected);
    }

    function connect() {
        stompClient.activate();
    }

    function disconnect() {
        stompClient.deactivate();
        setConnected(false);
        console.log("Disconnected");
    }

    $(function () {
        $("form").on('submit', (e) => e.preventDefault());
        $( "#connect" ).click(() => connect());
        $( "#disconnect" ).click(() => disconnect());
    });
	
</script>
</body>
</html>