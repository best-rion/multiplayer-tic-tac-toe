<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <title>tic-tac-toe</title>
</head>
<body>

	<h2>Username: <span th:text="${principal}"></span> <span id="turn"></span></h2>
	<h3>Opponent: <span th:text="${opponent}"></span> <span id="message"></span></h3>
	
	
	<div id="options">
		<p id="wins"></p>
		<a id="reset">play again</a>
		<a th:href="@{/dashboard}">quit game</a>
	</div>
	
    <div id="container"></div>
	
	<input type="text" th:value="${principal}" id="principal" hidden>

<script>
	var iAmReadyToReset = false
	var opponentIsReadyToReset = false
	var gameOn = true;
	
	var myTurn = false;
	var mySymbol = 'X';
	
	const stompClient = new StompJs.Client({
	    brokerURL: 'ws://localhost:8080/websocket'
	});

    var cells = new Array()
    var container = document.getElementById("container")
	
	
	function reset()
	{
		$("#options").hide()
		
		for (var y=0; y<3; y++)
        {
            for (var x=0; x<3; x++)
            {
                cells[y][x].innerHTML="";
            }
        }
		
		gameOn=true
		
		iAmReadyToReset = false
		opponentIsReadyToReset = false
		
		$("#message").html( " (Ready)" )
	}

    window.onload = ()=>{
		
		$("#options").hide()

		stompClient.activate();
		
		for (var y=0; y<3; y++)
        {
			var row = new Array()
            for (var x=0; x<3; x++)
            {
                var cell = document.createElement("button")
                cell.setAttribute("class", "cell")
                cell.setAttribute("onclick", "makeMove("+x+","+y+")")
                cell.style.left = (50*x)+"px"
                cell.style.top = (50*y)+"px"
                container.appendChild(cell)
				row.push(cell)
            }
			cells.push(row)
        }
		
		stompClient.publish({
            destination: "/app/inHome",
            body: JSON.stringify({'username':$("#principal").val()})
        });
		
    }

	function makeMove(x,y)
	{
		if (myTurn && gameOn && cells[y][x].innerHTML==="")
		{
			stompClient.publish({
			    destination: "/app/makeMove",
			    body: JSON.stringify({ 'x': x, 'y': y, 'symbol':null })
			});
		}
	}
	
	var winScenarios =
	[
		[ [0,0],[0,1],[0,2] ],
		[ [1,0],[1,1],[1,2] ],
		[ [2,0],[2,1],[2,2] ],
		
		[ [0,0],[1,0],[2,0] ],
		[ [0,1],[1,1],[2,1] ],
		[ [0,2],[1,2],[2,2] ],
		
		[ [0,0],[1,1],[2,2] ],
		[ [2,0],[1,1],[0,2] ]
	]
	
	function checkWinScenarios()
	{
		for (var i=0; i<8; i++)
		{
			if(
				(
				cells[ winScenarios[i][0][1] ][ winScenarios[i][0][0] ].innerHTML
				== 
				cells[ winScenarios[i][1][1] ][ winScenarios[i][1][0] ].innerHTML
			   	)
				&&
				(
				cells[ winScenarios[i][0][1] ][ winScenarios[i][0][0] ].innerHTML 
				== 
				cells[ winScenarios[i][2][1] ][ winScenarios[i][2][0] ].innerHTML 
			   	)
				&&
				(
				cells[ winScenarios[i][0][1] ][ winScenarios[i][0][0] ].innerHTML != ""
				)
			  )
			  {
				$("#wins").html(cells[ winScenarios[i][0][1] ][ winScenarios[i][0][0] ].innerHTML+" wins")
				$("#options").show()
				gameOn = false;
			  }
		}
	}

    function updateBoard(move)
    {
        var x = parseInt(move.x)
        var y = parseInt(move.y)
        cells[y][x].innerHTML = move.symbol
		
		checkWinScenarios()
		
    }


    stompClient.onConnect = (frame) => {
		
        console.log('Connected: ' + frame);
		
        stompClient.subscribe('/user/queue/move', (move) => {
            console.log(move.headers["message-id"])
            updateBoard(JSON.parse(move.body));
			if (JSON.parse(move.body).symbol === mySymbol)
			{
				myTurn = false;
				$("#turn").html( "Opponent's Turn" )
			}
			else
			{
				myTurn = true;
				$("#turn").html( "Your Turn ( "+mySymbol+" )" )
			}
			
        });
		
		stompClient.subscribe('/user/queue/opponentMessage', (message) => {
            console.log(message.headers["message-id"])
            $("#message").html( " ("+JSON.parse(message.body).content+")" )
			
			if (JSON.parse(message.body).content === 'Ready')
			{
				myTurn=true
				mySymbol='O'
				$("#turn").html( "Your Turn ( O )" )
			}
			
			if (JSON.parse(message.body).content === 'playAgain')
			{
				opponentIsReadyToReset = true
				
				if (iAmReadyToReset)
				{
					reset();
				}
			}
        });
		
		stompClient.publish({
            destination: "/app/inHome",
            body: JSON.stringify({'username':$("#principal").val()})
        });
    };
	
	window.onbeforeunload = function () {
		stompClient.deactivate();
		stompClient.publish({
	        destination: "/app/outtaHome",
	        body: JSON.stringify({'username':$("#principal").val()})
	    });
	};
	

	stompClient.onWebSocketError = (error) => {
	    console.error('Error with websocket', error);
	};

	stompClient.onStompError = (frame) => {
	    console.error('Broker reported error: ' + frame.headers['message']);
	    console.error('Additional details: ' + frame.body);
	};
	
	$(function () {
	    $( "#reset" ).click(() => {
			iAmReadyToReset = true;
			
			stompClient.publish({
			    destination: "/app/letsPlayAgain",
			    body: JSON.stringify({'username':$("#principal").val()})
			});
			
			if (opponentIsReadyToReset)
			{
				reset();
			}
		});
	});
	
</script>
</body>
</html>